#!/usr/bin/env ruby

require 'hiiro'

Hiiro.run(*ARGV) do
  add_subcmd(:ls)  { |*args| system('git', 'worktree', 'list', *args) }
  add_subcmd(:list)  { |*args| run_subcmd(:ls, *args) }
  add_subcmd(:add)  { |*args| system('git', 'worktree', 'add', *args) }
  add_subcmd(:lock)  { |*args| system('git', 'worktree', 'lock', *args) }
  add_subcmd(:move)  { |*args| system('git', 'worktree', 'move', *args) }
  add_subcmd(:prune)  { |*args| system('git', 'worktree', 'prune', *args) }
  add_subcmd(:remove)  { |*args| system('git', 'worktree', 'remove', *args) }
  add_subcmd(:repair)  { |*args| system('git', 'worktree', 'repair', *args) }
  add_subcmd(:unlock)  { |*args| system('git', 'worktree', 'unlock', *args) }

  add_subcmd(:select) do |*args|
    # Get worktree list
    output = `git worktree list`.strip

    if output.empty?
      STDERR.puts "No worktrees found"
      next
    end

    lines = output.split("\n").each_with_object({}) do |line, hash|
      # Format: /path/to/worktree  sha [branch]
      path = line.split.first
      hash[line] = path
    end

    selected = fuzzyfind_from_map(lines)

    if selected
      print selected
    end
  end

  add_subcmd(:copy) do |*args|
    output = `git worktree list`.strip

    if output.empty?
      STDERR.puts "No worktrees found"
      next
    end

    lines = output.split("\n").each_with_object({}) do |line, hash|
      path = line.split.first
      hash[line] = path
    end

    selected = fuzzyfind_from_map(lines)

    if selected
      Hiiro::Shell.pipe(selected, 'pbcopy')
      puts "Copied worktree path '#{selected}' to clipboard"
    end
  end
end
