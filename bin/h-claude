#!/usr/bin/env ruby

require 'hiiro'
require 'shellwords'

opts = Hiiro::Options.setup {
  flag(:danger, short: :d, default: false)
  flag(:horizontal, short: :h, default: false)
  flag(:percent, short: :p, default: false)
  option(:size, short: :s, default: nil)
}

def start_command(opts)
  shell = ENV['SHELL'] || 'zsh'
  escaped_args = opts.args.map(&:shellescape)
  if opts.danger
    escaped_args = ['--dangerously-skip-permissions', *escaped_args]
  end
  ['claude', *escaped_args, ";exec #{shell}"].join(' ')
end

Hiiro.run(*ARGV, plugins: [Pins]) {
  add_subcmd(:split) { |*args|
    opts = opts.parse(args)
    direction = opts.horizontal ? '-v' : '-h'

    size = opts.size || '40'
    size += '%' if opts.percent

    system('tmux', 'split-window', direction, '-l', size, start_command(opts))
  }

  add_subcmd(:vsplit) { |*args|
    size = '40%'

    opts = opts.parse(args)

    if opts.size
      size = opts.size
      size += '%' if opts.percent
    end

    system('tmux', 'split-window', '-h', '-l', size, start_command(opts))
  }

  add_subcmd(:hsplit) { |*args|
    size = '40%'

    opts = opts.parse(args)

    if opts.size
      size = opts.size
      size += '%' if opts.percent
    end

    system('tmux', 'split-window', '-v', '-l', size, start_command(opts))
  }
}
