#!/usr/bin/env ruby

require 'hiiro'

Hiiro.run(*ARGV, plugins: [Pins]) do
  add_subcmd(:select) do |*select_args|
    # Get git log with format: sha - subject
    log_output = `git log --oneline -100 #{select_args.join(' ')}`.strip

    if log_output.empty?
      STDERR.puts "No commits found"
      next
    end

    lines = log_output.split("\n").each_with_object({}) do |line, h|
      sha = line.split.first
      h[line] = sha
    end

    selected = fuzzyfind_from_map(lines)

    if selected
      print selected
    end
  end

  add_subcmd(:ls) do |*ls_args|
    system('git', 'log', '--oneline', *ls_args)
  end

  add_subcmd(:show) do |sha = nil, *show_args|
    if sha.nil?
      sha = `h sha select`.strip
      next if sha.empty?
    end

    system('git', 'show', sha, *show_args)
  end

  add_subcmd(:copy) do |sha = nil, *copy_args|
    if sha.nil?
      sha = `h sha select`.strip
      next if sha.empty?
    end

    Hiiro::Shell.pipe(sha, 'pbcopy')
    puts "Copied #{sha} to clipboard"
  end
end
