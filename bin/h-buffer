#!/usr/bin/env ruby

require "hiiro"

def buffer_names
  `tmux list-buffers -F '\#{buffer_name}'`.strip.split("\n")
end

def find_buffer(partial)
  buffer_list = buffer_names

  buffer, *other = buffer_list.grep(Regexp.new(partial))

  return nil if other.any?

  buffer
end

def select_buffer(partial = nil)
  names = buffer_names
  return nil if names.empty?

  if partial
    names = names.grep(Regexp.new(partial))
  end

  return nil if names.empty?
  return names.first if names.length == 1

  selected, status = Hiiro::Fuzzyfind.select(names)
  return nil unless status.success?

  selected.strip.empty? ? nil : selected.strip
end

o = Hiiro.init(*ARGV, plugins: [Pins])

o.add_subcmd(:ls) { |*args|
  system('tmux', 'list-buffers', *args)
}

o.add_subcmd(:show) { |name = nil, *args|
  buffer = select_buffer(name)
  unless buffer
    puts "No buffer selected or found"
    next
  end

  system('tmux', 'show-buffer', '-b', buffer, *args)
}

o.add_subcmd(:copy) { |name = nil, *args|
  buffer = select_buffer(name)
  unless buffer
    puts "No buffer selected or found"
    next
  end

  require 'open3'
  content = `tmux show-buffer -b #{buffer}`
  Open3.popen3('pbcopy') do |stdin, stdout, stderr, wait_thr|
    stdin.write(content)
    stdin.close
    wait_thr.value
  end
  puts "Copied buffer '#{buffer}' to clipboard"
}

o.add_subcmd(:save) { |*args|
  system('tmux', 'save-buffer', *args)
}

o.add_subcmd(:load) { |*args|
  system('tmux', 'load-buffer', *args)
}

o.add_subcmd(:set) { |*args|
  system('tmux', 'set-buffer', *args)
}

o.add_subcmd(:paste) { |*args|
  system('tmux', 'paste-buffer', *args)
}

o.add_subcmd(:delete) { |*args|
  system('tmux', 'delete-buffer', *args)
}

o.add_subcmd(:choose) { |*args|
  system('tmux', 'choose-buffer', *args)
}

o.add_subcmd(:clear) { |*args|
  # Delete all buffers
  buffers = `tmux list-buffers -F '\#{buffer_name}'`.strip.split("\n")
  buffers.each { |buf| system('tmux', 'delete-buffer', '-b', buf) }
  puts "Cleared #{buffers.count} buffers"
}

o.add_subcmd(:select) do |*args|
  # Get buffer list with content preview
  output = `tmux list-buffers -F '\#{buffer_name}: \#{buffer_sample}'`.strip

  if output.empty?
    STDERR.puts "No buffers found"
    next
  end

  lines = output.split("\n").each_with_object({}) do |line, h|
    buffer_name = line.split(':').first
    h[line] = buffer_name
  end

  selected = o.fuzzyfind_from_map(lines)

  if selected
    print selected
  end
end

o.run
