#!/usr/bin/env ruby

require "hiiro"

def buffer_names
  `tmux list-buffers -F '\#{buffer_name}'`.strip.split("\n")
end

def show_buffer(name, *args)
  `tmux show-buffer -b #{name.shellescape} #{args.shelljoin}`
end

def buffer_map
  output = `tmux list-buffers -F '\#{buffer_name}: \#{buffer_sample}'`.strip

  lines = output.split("\n").each_with_object({}) do |line, h|
    buffer_name = line.split(': ', 2).first
    h[line] = buffer_name
  end
end

def find_buffer(partial)
  buffer_list = buffer_names

  buffer, *other = buffer_list.grep(Regexp.new(partial))

  return nil if other.any?

  buffer
end

def select_buffer(partial = nil)
  buffers = buffer_map
  return nil if buffers.empty?

  if partial
    buffers = buffers.select{|k,v| ![k.to_s, v.to_s].grep(Regexp.new(partial)).empty? }
  end

  return nil if buffers.empty?
  return buffers.first if buffers.length == 1

  Hiiro::Fuzzyfind.map_select(buffers)
end

o = Hiiro.init(*ARGV, plugins: [Pins])

o.add_subcmd(:ls) { |*args|
  system('tmux', 'list-buffers', *args)
}

o.add_subcmd(:show) { |name = nil, *args|
  buffer = select_buffer(name)

  unless buffer
    puts "No buffer selected or found"
    next
  end

  print show_buffer(buffer, *args)
}

o.add_subcmd(:copy) { |name = nil, *args|
  buffer = select_buffer(name)
  unless buffer
    puts "No buffer selected or found"
    next
  end

  content = show_buffer(buffer)
  Hiiro::Shell.pipe(content, 'pbcopy')
  puts "Copied buffer '#{buffer}' to clipboard"
}

o.add_subcmd(:save) { |*args|
  system('tmux', 'save-buffer', *args)
}

o.add_subcmd(:load) { |*args|
  system('tmux', 'load-buffer', *args)
}

o.add_subcmd(:set) { |*args|
  system('tmux', 'set-buffer', *args)
}

o.add_subcmd(:paste) { |*args|
  system('tmux', 'paste-buffer', *args)
}

o.add_subcmd(:delete) { |*args|
  system('tmux', 'delete-buffer', *args)
}

o.add_subcmd(:choose) { |*args|
  system('tmux', 'choose-buffer', *args)
}

o.add_subcmd(:clear) { |*args|
  # Delete all buffers
  buffers = `tmux list-buffers -F '\#{buffer_name}'`.strip.split("\n")
  buffers.each { |buf| system('tmux', 'delete-buffer', '-b', buf) }
  puts "Cleared #{buffers.count} buffers"
}

o.add_subcmd(:select) do |*args|
  # Get buffer list with content preview
  output = `tmux list-buffers -F '\#{buffer_name}: \#{buffer_sample}'`.strip

  if output.empty?
    STDERR.puts "No buffers found"
    next
  end

  lines = output.split("\n").each_with_object({}) do |line, h|
    buffer_name = line.split(':').first
    h[line] = buffer_name
  end

  selected = o.fuzzyfind_from_map(lines)

  if selected
    print selected
  end
end

o.run
