#!/usr/bin/env ruby

require 'hiiro'

o = Hiiro.init(*ARGV, plugins: [Pins])

o.add_subcmd(:ls) { |*args|
  system('tmux', 'list-panes', *args)
}

o.add_subcmd(:lsa) { |*args|
  system('tmux', 'list-panes', '-a', *args)
}

o.add_subcmd(:split) { |*args|
  system('tmux', 'split-window', *args)
}

o.add_subcmd(:splitv) { |*args|
  system('tmux', 'split-window', '-v', *args)
}

o.add_subcmd(:splith) { |*args|
  system('tmux', 'split-window', '-h', *args)
}

o.add_subcmd(:kill) { |*args|
  system('tmux', 'kill-pane', *args)
}

o.add_subcmd(:swap) { |*args|
  system('tmux', 'swap-pane', *args)
}

o.add_subcmd(:zoom) { |*args|
  system('tmux', 'resize-pane', '-Z', *args)
}

o.add_subcmd(:capture) { |*args|
  system('tmux', 'capture-pane', *args)
}

o.add_subcmd(:select) { |*args|
  system('tmux', 'select-pane', *args)
}

o.add_subcmd(:move) { |*args|
  system('tmux', 'move-pane', *args)
}

o.add_subcmd(:break) { |*args|
  system('tmux', 'break-pane', *args)
}

o.add_subcmd(:join) { |*args|
  system('tmux', 'join-pane', *args)
}

o.add_subcmd(:resize) { |*args|
  system('tmux', 'resize-pane', *args)
}

o.add_subcmd(:select) do |*args|
  # Get all panes with details
  output = `tmux list-panes -a -F '\#{session_name}:\#{window_index}.\#{pane_index} [\#{pane_current_command}] \#{pane_current_path}'`.strip

  if output.empty?
    STDERR.puts "No panes found"
    next
  end

  lines = output.split("\n").each_with_object({}) do |line, h|
    pane_id = line.split.first
    h[line] = pane_id
  end

  selected = o.fuzzyfind_from_map(lines)

  if selected
    print selected
  end
end

o.run
