#!/usr/bin/env ruby

require 'hiiro'

o = Hiiro.init(*ARGV, plugins: [Pins])
tmux = o.tmux_client

o.add_subcmd(:ls) { |*args|
  if args.empty?
    tmux.panes.each { |p| puts p.to_s }
  else
    system('tmux', 'list-panes', *args)
  end
}

o.add_subcmd(:lsa) { |*args|
  if args.empty?
    tmux.panes(all: true).each { |p| puts p.to_s }
  else
    system('tmux', 'list-panes', '-a', *args)
  end
}

o.add_subcmd(:split) { |*args|
  system('tmux', 'split-window', *args)
}

o.add_subcmd(:splitv) { |*args|
  if args.empty?
    tmux.split_window(horizontal: false)
  else
    system('tmux', 'split-window', '-v', *args)
  end
}

o.add_subcmd(:splith) { |*args|
  if args.empty?
    tmux.split_window(horizontal: true)
  else
    system('tmux', 'split-window', '-h', *args)
  end
}

o.add_subcmd(:kill) { |target = nil, *args|
  if target.nil?
    panes = tmux.panes(all: true)
    mapping = panes.each_with_object({}) { |p, h| h[p.to_s] = p.id }
    target = o.fuzzyfind_from_map(mapping)
  end

  if target && args.empty?
    tmux.kill_pane(target)
  elsif target
    system('tmux', 'kill-pane', '-t', target, *args)
  end
}

o.add_subcmd(:swap) { |*args|
  system('tmux', 'swap-pane', *args)
}

o.add_subcmd(:zoom) { |target = nil, *args|
  if args.empty?
    tmux.resize_pane(target: target, zoom: true)
  else
    system('tmux', 'resize-pane', '-Z', *[target && "-t", target, *args].compact)
  end
}

o.add_subcmd(:capture) { |*args|
  if args.empty?
    content = tmux.capture_pane
    print content if content
  else
    system('tmux', 'capture-pane', *args)
  end
}

o.add_subcmd(:select) { |target = nil, *args|
  if target.nil?
    panes = tmux.panes(all: true)
    mapping = panes.each_with_object({}) { |p, h| h[p.to_s] = p.id }
    target = o.fuzzyfind_from_map(mapping)
  end

  if target && args.empty?
    tmux.select_pane(target)
  elsif target
    system('tmux', 'select-pane', '-t', target, *args)
  end
}

o.add_subcmd(:move) { |*args|
  system('tmux', 'move-pane', *args)
}

o.add_subcmd(:break) { |*args|
  if args.empty?
    tmux.break_pane
  else
    system('tmux', 'break-pane', *args)
  end
}

o.add_subcmd(:join) { |*args|
  system('tmux', 'join-pane', *args)
}

o.add_subcmd(:resize) { |*args|
  system('tmux', 'resize-pane', *args)
}

o.add_subcmd(:width) { |size, target = nil, *args|
  if target.nil? && args.empty?
    tmux.resize_pane(width: size)
  else
    system('tmux', 'resize-pane', '-x', size, *[target && "-t", target, *args].compact)
  end
}

o.add_subcmd(:height) { |size, target = nil, *args|
  if target.nil? && args.empty?
    tmux.resize_pane(height: size)
  else
    system('tmux', 'resize-pane', '-y', size, *[target && "-t", target, *args].compact)
  end
}

o.add_subcmd(:info) { |target = nil|
  pane = if target
    tmux.panes(all: true).find { |p| p.id == target }
  else
    tmux.current_pane
  end

  if pane
    puts pane.to_s
    puts "  Size: #{pane.width}x#{pane.height}"
    puts "  Command: #{pane.command}"
    puts "  Path: #{pane.path}"
  else
    puts "Pane not found"
  end
}

o.run
