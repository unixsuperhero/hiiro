#!/usr/bin/env ruby

require 'hiiro'

o = Hiiro.init(*ARGV, plugins: [Pins])
tmux = o.tmux_client

o.add_subcmd(:ls) { |*args|
  if args.empty?
    tmux.windows.each { |w| puts w.to_s }
  else
    system('tmux', 'list-windows', *args)
  end
}

o.add_subcmd(:lsa) { |*args|
  if args.empty?
    tmux.windows(all: true).each { |w| puts w.to_s }
  else
    system('tmux', 'list-windows', '-a', *args)
  end
}

o.add_subcmd(:new) { |name = nil, *args|
  if args.empty?
    tmux.new_window(name: name)
  else
    system('tmux', 'new-window', *[name && "-n", name, *args].compact)
  end
}

o.add_subcmd(:kill) { |target = nil, *args|
  if target.nil?
    windows = tmux.windows(all: true)
    mapping = windows.each_with_object({}) { |w, h| h[w.to_s] = w.target }
    target = o.fuzzyfind_from_map(mapping)
  end

  if target && args.empty?
    tmux.kill_window(target)
  elsif target
    system('tmux', 'kill-window', '-t', target, *args)
  end
}

o.add_subcmd(:rename) { |*args|
  system('tmux', 'rename-window', *args)
}

o.add_subcmd(:swap) { |*args|
  system('tmux', 'swap-window', *args)
}

o.add_subcmd(:move) { |*args|
  system('tmux', 'move-window', *args)
}

o.add_subcmd(:select) { |target = nil, *args|
  if target.nil?
    windows = tmux.windows(all: true)
    mapping = windows.each_with_object({}) { |w, h| h[w.to_s] = w.target }
    target = o.fuzzyfind_from_map(mapping)
  end

  if target && args.empty?
    tmux.select_window(target)
  elsif target
    system('tmux', 'select-window', '-t', target, *args)
  end
}

o.add_subcmd(:next) { |*args|
  if args.empty?
    tmux.next_window
  else
    system('tmux', 'next-window', *args)
  end
}

o.add_subcmd(:prev) { |*args|
  if args.empty?
    tmux.previous_window
  else
    system('tmux', 'previous-window', *args)
  end
}

o.add_subcmd(:last) { |*args|
  if args.empty?
    tmux.last_window
  else
    system('tmux', 'last-window', *args)
  end
}

o.add_subcmd(:link) { |*args|
  system('tmux', 'link-window', *args)
}

o.add_subcmd(:unlink) { |target = nil, *args|
  if target && args.empty?
    tmux.unlink_window(target)
  else
    system('tmux', 'unlink-window', *[target && "-t", target, *args].compact)
  end
}

o.add_subcmd(:info) { |target = nil|
  window = if target
    tmux.windows(all: true).find { |w| w.target == target || w.name == target }
  else
    tmux.current_window
  end

  if window
    puts window.to_s
  else
    puts "Window not found"
  end
}

o.run
