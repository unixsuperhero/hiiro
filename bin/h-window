#!/usr/bin/env ruby

require 'hiiro'

o = Hiiro.init(*ARGV, plugins: [Pins])

o.add_subcmd(:ls) { |*args|
  system('tmux', 'list-windows', *args)
}

o.add_subcmd(:lsa) { |*args|
  system('tmux', 'list-windows', '-a', *args)
}

o.add_subcmd(:new) { |*args|
  system('tmux', 'new-window', *args)
}

o.add_subcmd(:kill) { |*args|
  system('tmux', 'kill-window', *args)
}

o.add_subcmd(:rename) { |*args|
  system('tmux', 'rename-window', *args)
}

o.add_subcmd(:swap) { |*args|
  system('tmux', 'swap-window', *args)
}

o.add_subcmd(:move) { |*args|
  system('tmux', 'move-window', *args)
}

o.add_subcmd(:select) { |*args|
  system('tmux', 'select-window', *args)
}

o.add_subcmd(:next) { |*args|
  system('tmux', 'next-window', *args)
}

o.add_subcmd(:prev) { |*args|
  system('tmux', 'previous-window', *args)
}

o.add_subcmd(:last) { |*args|
  system('tmux', 'last-window', *args)
}

o.add_subcmd(:link) { |*args|
  system('tmux', 'link-window', *args)
}

o.add_subcmd(:unlink) { |*args|
  system('tmux', 'unlink-window', *args)
}

o.add_subcmd(:history) { |window_id=nil|
  window_id ||= `tmux display-message -p '#I'`.strip if ENV['TMUX']
  entries = Hiiro::History.by_window(window_id)
  if entries.empty?
    puts "No history for this window"
  else
    puts "History for window: #{window_id || 'current'}"
    puts
    entries.last(20).each_with_index { |e, i| puts e.oneline(i + 1) }
  end
}

o.add_subcmd(:select) do |*args|
  # Get all windows with details
  output = `tmux list-windows -a -F '\#{session_name}:\#{window_index} \#{window_name} [\#{window_panes} panes]'`.strip

  if output.empty?
    STDERR.puts "No windows found"
    next
  end

  lines = output.split("\n").each_with_object({}) do |line, h|
    window_id = line.split.first
    h[line] = window_id
  end

  selected = Hiiro::Sk.map_select(lines)

  if selected
    print selected
  end
end

o.run
