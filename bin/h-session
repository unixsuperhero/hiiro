#!/usr/bin/env ruby

require 'hiiro'

Hiiro.run(*ARGV, plugins: [Pins]) do
  tmux = tmux_client

  add_subcmd(:ls, :list) { |*args|
    if args.empty?
      tmux.sessions.each { |s| puts s.to_s }
    else
      system('tmux', 'list-sessions', *args)
    end
  }

  add_subcmd(:new) { |name = nil, *args|
    if name && args.empty?
      tmux.new_session(name, detached: false)
    else
      system('tmux', 'new-session', *[name, *args].compact)
    end
  }

  add_subcmd(:kill) { |name = nil, *args|
    if name.nil?
      name = fuzzyfind(tmux.sessions.names)
    end

    if name && args.empty?
      tmux.kill_session(name)
    elsif name
      system('tmux', 'kill-session', '-t', name, *args)
    end
  }

  add_subcmd(:attach) { |name = nil, *args|
    if name.nil?
      name = fuzzyfind(tmux.sessions.names)
    end

    if name && args.empty?
      tmux.attach_session(name)
    elsif name
      system('tmux', 'attach-session', '-t', name, *args)
    end
  }

  add_subcmd(:rename) { |old_name = nil, new_name = nil, *args|
    if old_name.nil?
      old_name = fuzzyfind(tmux.sessions.names)
    end

    if old_name && new_name && args.empty?
      tmux.rename_session(old_name, new_name)
    elsif old_name
      system('tmux', 'rename-session', '-t', old_name, *[new_name, *args].compact)
    end
  }

  add_subcmd(:switch) { |name = nil, *args|
    if name.nil?
      name = fuzzyfind(tmux.sessions.names)
    end

    if name && args.empty?
      tmux.switch_client(name)
    elsif name
      system('tmux', 'switch-client', '-t', name, *args)
    end
  }

  add_subcmd(:detach) { |*args|
    if args.empty?
      tmux.detach_client
    else
      system('tmux', 'detach-client', *args)
    end
  }

  add_subcmd(:has) { |name = nil, *args|
    if name && args.empty?
      tmux.session_exists?(name)
    else
      system('tmux', 'has-session', *[name, *args].compact)
    end
  }

  add_subcmd(:info) { |name = nil, *args|
    if name.nil? && args.empty?
      session = tmux.current_session
      if session
        puts "#{session.name}: #{session.windows} windows#{session.attached? ? ', attached' : ''}"
      end
    else
      system('tmux', 'display-message', '-p', '#{session_name}: #{session_windows} windows, #{session_attached} attached', *['-t', name, *args].compact)
    end
  }

  add_subcmd(:open) { |name = nil|
    if name.nil?
      puts "Usage: h session open <name>"
      next
    end
    tmux.open_session(name)
  }

  add_subcmd(:select) do
    sessions = tmux.sessions
    if sessions.empty?
      STDERR.puts "No sessions found"
      next
    end

    mapping = sessions.each_with_object({}) { |s, h| h[s.to_s] = s.name }
    selected = fuzzyfind_from_map(mapping)
    print selected if selected
  end
end
