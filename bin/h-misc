#!/usr/bin/env ruby

require 'hiiro'

Hiiro.run {
  add_subcmd(:symlinks) do |*args|
    opts = Hiiro::Options.parse(args) do
      option(:root, short: :r, desc: 'root path')
    end

    pwd = Hiiro::Paths.new(Dir.pwd)
    outside_basedir = opts.args.inject({}) do |basedir,h|
      real_base = pwd.child(basedir)
      symlinks = pwd.symlinks_in(real_base)

      mapping = symlinks.each_with_object({}) do |link,h|
        h[link] = pwd.symlink_dest(link)
      end

      outside = mapping.select{|link,dest|
        pwd.outside_dir?(dest, real_base)
      }

      outside.each do |link,dest|
        puts
        puts "LINK: #{link}"
        puts "DEST: #{dest}"
        puts "is outside => #{real_base}"
      end
    end
  end
}

