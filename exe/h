#!/usr/bin/env ruby

require "hiiro"
require "fileutils"

def update_hiiro
  if `gem list hiiro`.strip.empty?
    system('gem', 'install', 'hiiro')
  else
    system('gem', 'update', 'hiiro')
  end

  system('h', 'setup')
end

def rbenv_versions
  versions = `rbenv versions --bare`.lines(chomp: true)
end

Hiiro.run(*ARGV, cwd: Dir.pwd, tasks: true) do
  add_subcmd(:version) { |*args|
    puts Hiiro::VERSION
  }

  add_subcmd(:ping) { |*args|
    puts "pong"
  }

  add_subcmd(:install) { |*args|
    opts = Hiiro::Options.setup {
      flag(:all, short: :a)
    }.parse!(ARGV)

    if opts.all
      rbenv_versions.each do |ver|
        ENV['RBENV_VERSION'] = ver
        update_hiiro
      end
    else
      update_hiiro
    end
  }

  add_subcmd(:setup) do |*args|
    # Detect how the command was invoked to determine prefix
    invoked_as = File.basename($0)
    prefix = invoked_as.split("-").first  # handles "h", "hiiro", or custom names

    gem_root = File.expand_path("../..", __FILE__)
    source_plugins = File.join(gem_root, "plugins")
    source_bins = File.join(gem_root, "bin")
    dest_plugins = File.expand_path("~/.config/hiiro/plugins")
    dest_bin = File.expand_path("~/bin")

    FileUtils.mkdir_p(dest_plugins)
    FileUtils.mkdir_p(dest_bin)

    # Copy plugins
    plugin_files = Dir["#{source_plugins}/*.rb"]
    if plugin_files.any?
      FileUtils.cp(plugin_files, dest_plugins)
      puts "Installed #{plugin_files.size} plugins to #{dest_plugins}"
      plugin_files.each { |f| puts "  - #{File.basename(f)}" }
    else
      puts "No plugins found in #{source_plugins}"
    end

    puts

    # Copy bin scripts, renaming from h-* to #{prefix}-*
    bin_groups = {
      'tmux'   => %w[buffer pane session window],
      'git'    => %w[branch commit sha wtree],
      'github' => %w[pr],
      'claude' => %w[claude],
      'hiiro'  => %w[bin plugin],
      'other'  => %w[app config link misc project todo],
    }

    bin_files = Dir["#{source_bins}/h-*"]
    if bin_files.any?
      bin_files.each do |src|
        old_name = File.basename(src)
        new_name = old_name.sub(/^h-/, "#{prefix}-")
        dest_path = File.join(dest_bin, new_name)
        FileUtils.cp(src, dest_path)
        FileUtils.chmod(0755, dest_path)
      end

      puts "Installed #{bin_files.size} subcommands to #{dest_bin}"
      puts

      bin_groups.each do |group, names|
        matched = names.select { |n| bin_files.any? { |f| File.basename(f) == "h-#{n}" } }
        next if matched.empty?

        puts "  #{group}:"
        matched.each { |n| puts "    #{prefix}-#{n}" }
      end

      # Any bins not in a group
      grouped = bin_groups.values.flatten
      ungrouped = bin_files
        .map { |f| File.basename(f).sub(/^h-/, '') }
        .reject { |n| grouped.include?(n) }
      if ungrouped.any?
        puts "  uncategorized:"
        ungrouped.each { |n| puts "    #{prefix}-#{n}" }
      end
    else
      puts "No subcmds found in #{source_bins}"
    end

    puts

    # Check if ~/bin is in PATH
    home_bin = File.expand_path("~/bin")
    path_dirs = ENV["PATH"].to_s.split(File::PATH_SEPARATOR)
    if path_dirs.any? { |dir| File.expand_path(dir) == home_bin }
      puts "Setup complete! ~/bin is already in your PATH."
    else
      puts "Setup complete!"
      puts
      puts "\e[33mWarning:\e[0m ~/bin is not in your PATH."
      puts
      puts "Add this to your shell config (~/.bashrc, ~/.zshrc, etc.):"
      puts
      puts "  export PATH=\"$HOME/bin:$PATH\""
      puts
      puts "Then reload your shell or run:"
      puts
      puts "  source ~/.bashrc  # or ~/.zshrc"
    end
  end

  add_subcmd(:alert) do |*args|
    Hiiro::Notification.show(self)
  end

  add_subcmd(:queue) do |*args|
    Hiiro::Queue.build_hiiro(self).run
  end
end
