#!/usr/bin/env ruby

require "hiiro"
require "fileutils"

Hiiro.run(*ARGV, cwd: Dir.pwd) do
  add_subcmd(:version) { |*args|
    puts Hiiro::VERSION
  }

  add_subcmd(:ping) { |*args|
    puts "pong"
  }

  add_subcmd(:setup) do |*args|
    # Detect how the command was invoked to determine prefix
    invoked_as = File.basename($0)
    prefix = invoked_as.split("-").first  # handles "h", "hiiro", or custom names

    gem_root = File.expand_path("../..", __FILE__)
    source_plugins = File.join(gem_root, "plugins")
    source_bins = File.join(gem_root, "bin")
    dest_plugins = File.expand_path("~/.config/hiiro/plugins")
    dest_bin = File.expand_path("~/bin")

    FileUtils.mkdir_p(dest_plugins)
    FileUtils.mkdir_p(dest_bin)

    # Copy plugins
    plugin_files = Dir["#{source_plugins}/*.rb"]
    if plugin_files.any?
      FileUtils.cp(plugin_files, dest_plugins)
      puts "Installed #{plugin_files.size} plugins to #{dest_plugins}"
      plugin_files.each { |f| puts "  - #{File.basename(f)}" }
    else
      puts "No plugins found in #{source_plugins}"
    end

    puts

    # Copy bin scripts, renaming from h-* to #{prefix}-*
    bin_files = Dir["#{source_bins}/h-*"]
    if bin_files.any?
      bin_files.each do |src|
        old_name = File.basename(src)
        new_name = old_name.sub(/^h-/, "#{prefix}-")
        dest_path = File.join(dest_bin, new_name)
        FileUtils.cp(src, dest_path)
        FileUtils.chmod(0755, dest_path)
      end
      puts "Installed #{bin_files.size} subcommands to #{dest_bin}"
      bin_files.each do |f|
        old_name = File.basename(f)
        new_name = old_name.sub(/^h-/, "#{prefix}-")
        puts "  - #{new_name}"
      end
    else
      puts "No subcmds found in #{source_bins}"
    end

    puts

    # Check if ~/bin is in PATH
    home_bin = File.expand_path("~/bin")
    path_dirs = ENV["PATH"].to_s.split(File::PATH_SEPARATOR)
    if path_dirs.any? { |dir| File.expand_path(dir) == home_bin }
      puts "Setup complete! ~/bin is already in your PATH."
    else
      puts "Setup complete!"
      puts
      puts "\e[33mWarning:\e[0m ~/bin is not in your PATH."
      puts
      puts "Add this to your shell config (~/.bashrc, ~/.zshrc, etc.):"
      puts
      puts "  export PATH=\"$HOME/bin:$PATH\""
      puts
      puts "Then reload your shell or run:"
      puts
      puts "  source ~/.bashrc  # or ~/.zshrc"
    end
  end

  add_subcmd(:alert) do |*args|
    Hiiro::Notification.show(self)
  end

  add_subcmd(:queue) do |*args|
    Hiiro::Queue.build_hiiro(self).run
  end
end
